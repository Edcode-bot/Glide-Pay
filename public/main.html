      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GlidePay</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.5/dist/index.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
        <style>
          body {
            background: #1c1c2b;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            padding-bottom: 100px;
          }
          .navbar-custom {
            background: #1c1c2b;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          .wallet-card {
            background: linear-gradient(135deg, #ff8a00, #e52e71);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 1rem 0;
            color: #fff;
          }
          .currency-card {
            background: #2d2d44;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            flex: 1;
          }
          .options-card {
            background: #2d2d44;
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
          }
          .option-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
          }
          .option-grid a div {
            background: #3c3c5a;
            padding: 1rem;
            border-radius: 12px;
            color: #fff;
            font-size: 0.9rem;
          }
          .option-card {
            background: #1c1b3b;
            border-radius: 16px;
            color: white;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.2);
            text-decoration: none;
          }
          .option-card:hover {
            background: #ff7e5f;
            color: white;
          }
          .history-card {
            background: #2d2d44;
            border-radius: 15px;
            padding: 1rem;
            color: #ccc;
          }
          .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2d44;
            border-top: 1px solid #444;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            z-index: 1000;
          }
          .nav-bottom i {
            font-size: 1.4rem;
            color: #ffa726;
          }
          .center-btn {
            background: #ffa726;
            color: #000;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: -25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          }
          #cryptoPopup {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2d44;
            border-top: 1px solid #555;
            padding: 1rem;
            color: #fff;
            z-index: 2000;
          }
          #cryptoPopup button {
            width: 100%;
            margin-bottom: 10px;
          }
          .wallet-connect-card {
            background: linear-gradient(135deg, #ff8a00, #e52e71);

  color: #1c1c2b;
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
  margin: 1rem 0;
  text-align: center;
}
.wallet-connect-card h5 {
  color: #2ecc71;
  margin-bottom: 0.5rem;
}
.wallet-connect-card p {
  color: #555;
  font-size: 0.9rem;
}
.connect-btn {
  margin-top: 1rem;
  padding: 0.75rem 1.5rem;
  background: #2ecc71;
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
}
.connect-btn:hover {
  background: #27ae60;
}
          body {
            margin: 0;
            background: #f3f1e7;
            font-family: 'Segoe UI', sans-serif;
          }

          h5, h6 {
            color: #1c1c2b;
          }

          .section-header {
            padding: 1rem;
            background: #fff;
          }

          .service-card {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
          }

          .service-grid {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
          }

          .service-item {
            width: 70px;
            text-align: center;
            cursor: pointer;
          }

          .service-item img {
            width: 36px;
            height: 36px;
            object-fit: contain;
          }

          .service-item span {
            display: block;
            font-size: 0.8rem;
            color: #333;
            margin-top: 0.4rem;
          }

          .popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
          }

          .popup-card {
            background: #fff;
            color: #000;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
          }

          .popup-card h5 {
            font-weight: bold;
            margin-bottom: 0.8rem;
          }

          .popup-card button {
            margin-top: 1rem;
          }
        </style>
      </head>
      <body>

        <!-- Top Navbar -->
        <div class="navbar-custom">
            <div>
                <h4 id="welcome-message">Hello ðŸ‘‹</h4>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="cart-icon" onclick="window.location.href='/cart.html'">
                    <i class="fas fa-shopping-cart" style="font-size: 1.4rem;"></i>
                    <span class="cart-badge" id="cartCount">0</span>
                </div>
                <a href="/profile.html" style="text-decoration: none;">
                    <div id="profile-initial" style="
                        width: 38px;
                        height: 38px;
                        background: #ffa726;
                        color: #1c1c2b;
                        font-weight: bold;
                        border-radius: 50%;
                        display: flex;
                        justify-content: center;
                        align-items: center;">
                    </div>
                </a>
            </div>
        </div>

<!-- Unified Wallet Card -->
<div class="wallet-card mb-4" style="background: linear-gradient(135deg, #4CAF50, #43A047); border-radius: 20px; padding: 1.5rem; color: #fff;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <small class="text-light">Wallet Balance</small>
      <h2 class="fw-bold">UGX <span id="balance">0</span></h2>
    </div>
    <button class="btn btn-light btn-sm" onclick="connectWallet()">Connect Wallet</button>
  </div>

  <!-- Add Cash Section -->
  <div>
    <p class="mb-2 fw-semibold text-light">Add Cash</p>
    <div class="d-flex justify-content-around align-items-center">
      <a href="https://mtn.co.ug" target="_blank">
        <img src="https://i.imghippo.com/files/NnO6259hU.png" alt="MTN" style="width: 50px;" />
      </a>
      <a href="https://airtel.com.ug" target="_blank">
        <img src="https://i.imghippo.com/files/DRfK9771gDE.png" alt="Airtel" style="width: 50px;" />
      </a>
      <a href="https://yourbank.com" target="_blank">
        <img src="https://i.imghippo.com/files/zu8776Gc.png" alt="Bank" style="width: 50px;" />
      </a>
    </div>
  </div>
</div>

        <div class="text-center my-4">
          <button class="btn btn-warning" onclick="startDivviReferral()">Claim Referral Rewards</button>
        </div>

        <!-- New Services Grid -->
        <div class="container mb-4">
          <div class="card bg-dark text-light rounded-4 shadow-lg p-4">
            <h5 class="fw-bold mb-3">Quick Services</h5>
            <div class="row g-3">
              <!-- Shopping -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #FF6B6B, #FF8E8E);" onclick="window.location.href='/services/shopping'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Shopping</h6>
                    <small>Browse & Buy</small>
                  </div>
                </div>
              </div>

              <!-- Bill Payments -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #4ECDC4, #45B7AF);" onclick="window.location.href='/services/bills'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-file-invoice fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Bills</h6>
                    <small>Pay Utilities</small>
                  </div>
                </div>
              </div>

              <!-- Housing -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #A8E6CF, #8ED7BE);" onclick="window.location.href='/services/housing'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-home fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Housing</h6>
                    <small>Rent & Stay</small>
                  </div>
                </div>
              </div>

              <!-- Loans -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #FFD93D, #F6C90E);" onclick="window.location.href='/services/financial/loans'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-hand-holding-usd fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Loans</h6>
                    <small>Quick Finance</small>
                  </div>
                </div>
              </div>

              <!-- Savings -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #6C5CE7, #5A4ED1);" onclick="window.location.href='/services/financial/savings'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-piggy-bank fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Savings</h6>
                    <small>Grow Money</small>
                  </div>
                </div>
              </div>

              <!-- Group Savings -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #FF8008, #FFA03C);" onclick="window.location.href='/services/financial/savings/group'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Group Save</h6>
                    <small>Save Together</small>
                  </div>
                </div>
              </div>

              <!-- Airtime -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #00B4DB, #0083B0);" onclick="window.location.href='/services/airtime'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-mobile-alt fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Airtime</h6>
                    <small>Top Up</small>
                  </div>
                </div>
              </div>

              <!-- Send Money -->
              <div class="col-6 col-md-3">
                <div class="card bg-gradient h-100 border-0" style="background: linear-gradient(45deg, #FF4B2B, #FF416C);" onclick="window.location.href='/services/transfer'">
                  <div class="card-body text-center text-white">
                    <i class="fas fa-paper-plane fa-2x mb-2"></i>
                    <h6 class="card-title text-white mb-1">Send Money</h6>
                    <small>Quick Transfer</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section-header">
          <h5>Select Services</h5>
        </div>

        <div class="container py-3">

          <!-- HOUSING -->
          <div class="service-card">
            <h6>Housing</h6>
            <div class="service-grid">
              <div class="service-item" onclick="openPopup('rentPopup')">
                <img src="/assets/rent.png" alt="Rent">
                <span>Rent</span>
              </div>
              <div class="service-item" onclick="openPopup('shortstayPopup')">
                <img src="/assets/airbnb.png" alt="Short Stay">
                <span>Short Stay</span>
              </div>
            </div>
          </div>

          <!-- BILLS -->
          <div class="service-card">
            <h6>Utility Bills</h6>
            <div class="service-grid">
              <div class="service-item" onclick="openPopup('electricityPopup')">
                <img src="/assets/electricity.png" alt="Electricity">
                <span>Electricity</span>
              </div>
              <div class="service-item" onclick="openPopup('waterPopup')">
                <img src="/assets/water.png" alt="Water">
                <span>Water</span>
              </div>
            </div>
          </div>

          <!-- FINANCE -->
          <div class="service-card">
            <h6>Financial Services</h6>
            <div class="service-grid">
              <div class="service-item" onclick="openPopup('loanPopup')">
                <img src="/assets/loan.png" alt="Loan">
                <span>Loan</span>
              </div>
              <div class="service-item" onclick="openPopup('savingPopup')">
                <img src="/assets/saving.png" alt="Saving">
                <span>Saving</span>
              </div>
            </div>
          </div>

        </div>

        <!-- POPUP CONTAINER -->
        <div id="popupOverlay" class="popup-overlay">
          <div class="popup-card">
            <div id="popupContent"></div>
            <button class="btn btn-dark w-100 mt-3" onclick="closePopup()">Close</button>
          </div>
        </div>

        <!-- POPUP TEMPLATES (hidden) -->
        <div style="display:none;">
          <div id="rentPopup">
            <h5>Rent</h5>
            <p>Pay your house rent using digital wallets, bank or MoMo. All payments are tracked.</p>
          </div>
          <div id="shortstayPopup">
            <h5>Short Stay</h5>
            <p>Book short rentals like Airbnb directly with verified property owners.</p>
          </div>
          <div id="electricityPopup">
            <h5>Electricity</h5>
            <p>Buy tokens or pay postpaid electricity bills from UMEME or other providers.</p>
          </div>
          <div id="waterPopup">
            <h5>Water</h5>
            <p>Pay your water bill securely from NWSC or your utility provider.</p>
          </div>
          <div id="loanPopup">
            <h5>Loan</h5>
            <p>Access emergency loans instantly based on your profile and history.</p>
          </div>
          <div id="savingPopup">
            <h5>Saving</h5>
            <p>Start saving with our flexible digital wallet savings feature.</p>
          </div>
        </div>

        

        <!-- Recent Transactions -->
  <div class="card bg-dark text-light rounded-4 shadow-lg px-3 py-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold mb-0">Recent Activity</h5>
      <a href="/transactions.html" class="btn btn-sm btn-outline-light rounded-pill">View more</a>
    </div>
    <div id="recent-transactions" class="text-muted text-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="mb-2 opacity-50">
        <path d="M4 2v20l4-4 4 4 4-4 4 4V2H4zm4 7h8m-8 4h8"/>
      </svg>
      <p>No transactions yet</p>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="nav-bottom">
  <a href="#"><i class="fas fa-home"></i></a>
  <a href="/chat" class="center-btn"><i class="fas fa-comment-dots"></i></a>
  <a href="/transactions.html"><i class="fas fa-chart-line"></i></a>
</div>

<!-- Crypto Popup -->
<div id="cryptoPopup">
  <h5 class="mb-3">Choose Action</h5>
  <button class="btn btn-outline-success" onclick="openDeposit()">Deposit</button>
  <button class="btn btn-outline-warning" onclick="openTransfer()">Transfer</button>
  <button class="btn btn-outline-light" onclick="closePopup()">Cancel</button>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastDivvi" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div id="toastBody" class="toast-body">Success!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { getDataSuffix, submitReferral } from 'https://cdn.jsdelivr.net/npm/@divvi/referral-sdk/+esm';
  import { createWalletClient, custom } from 'https://esm.sh/viem';
  import { celo } from 'https://esm.sh/viem/chains';

  function showToast(message, type = 'success') {
    const toastEl = document.getElementById('toastDivvi');
    const toastBody = document.getElementById('toastBody');

    toastBody.textContent = message;
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;

    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  window.startDivviReferral = async function () {
    try {
      if (!window.ethereum) return showToast('Wallet not found. Install MetaMask or Celo Wallet.', 'danger');

      const addresses = await window.ethereum.request({ method: 'eth_requestAccounts' });
      if (!addresses.length) return showToast('Wallet not connected.', 'danger');

      const account = addresses[0];
      const walletClient = createWalletClient({ chain: celo, transport: custom(window.ethereum), account });

      const dataSuffix = getDataSuffix({
        consumer: '0xe38a456433fff7814e40998cf0cbbbd2c885b513',
        providers: ['0x0423189886d7966f0dd7e7d256898daeee625dca','0x5f0a55fad9424ac99429f635dfb9bf20c3360ab8','0x6226dde08402642964f9a6de844ea3116f0dfc7e']
      });

      const txHash = await walletClient.sendTransaction({
        account,
        to: '0x0000000000000000000000000000000000000000',
        data: '0x' + dataSuffix,
        value: 0n
      });

      const chainId = await walletClient.getChainId();
      await submitReferral({ txHash, chainId });
      showToast('Referral submitted successfully!');
    } catch (err) {
      console.error('Referral failed:', err);
      const msg = err.message.includes('No providers') ? 'No campaign detected or already submitted.' : 'Transaction failed. Check network.';
      showToast(msg, 'danger');
    }
  };

  // Page Load
  window.onload = async () => {
    const profile = await fetch('/user-profile').then(r => r.json());
    const firstName = (profile.name || 'User').split(' ')[0];
    const emailInitial = (profile.email || 'U')[0].toUpperCase();
    document.getElementById('welcome-message').innerText = `Hello, ${firstName} ðŸ‘‹`;
    document.getElementById('profile-initial').innerText = emailInitial;

    const balance = await fetch('/balance').then(r => r.json());
    document.getElementById('balance').innerText = balance.balance;

    const txs = await fetch('/transactions').then(r => r.json());
    const container = document.getElementById("recent-transactions");
    container.innerHTML = '';
    const recent = txs.slice(0, 3);

    if (recent.length === 0) {
      container.innerHTML = `<div class="text-center text-muted">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="mb-2 opacity-50">
          <path d="M4 2v20l4-4 4 4 4-4 4 4V2H4zm4 7h8m-8 4h8"/>
        </svg>
        <p>No transactions yet</p>
      </div>`;
    } else {
      recent.forEach(tx => {
        const color = tx.type.toLowerCase().includes('withdraw') ? 'text-danger' : 'text-success';
        const sign = tx.type.toLowerCase().includes('withdraw') ? '-' : '+';
        container.innerHTML += `
          <div class="d-flex justify-content-between border-bottom py-2">
            <div>
              <div class="fw-semibold">${tx.type}</div>
              <div class="small text-secondary">${new Date(tx.date).toLocaleDateString()}</div>
            </div>
            <div class="fw-bold ${color}">${sign} UGX ${tx.amount}</div>
          </div>`;
      });
    }
  };

  // Crypto Popup logic
  let selectedCurrency = "";
  function showPopup(currency) {
    selectedCurrency = currency;
    document.getElementById("cryptoPopup").style.display = "block";
  }
  function closePopup() {
    document.getElementById("cryptoPopup").style.display = "none";
  }
  function openDeposit() {
    window.location.href = "wallet-deposit.html?currency=" + selectedCurrency;
  }
  function openTransfer() {
    window.location.href = "wallet-transfer.html?currency=" + selectedCurrency;
  }
</script>

<script>
    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: {
            44787: "https://alfajores-forno.celo-testnet.org"
          },
          chainId: 44787
        }
      }
    };

    const web3Modal = new window.Web3Modal.default({
      network: "celo-alfajores",
      cacheProvider: false,
      providerOptions,
      theme: "dark"
    });

    async function connectWallet() {
      try {
        const instance = await web3Modal.connect();
        const provider = new ethers.providers.Web3Provider(instance);
        const signer = provider.getSigner();
        const address = await signer.getAddress();

        console.log("Connected wallet address:", address);
        alert("Wallet Connected:\n" + address);

        localStorage.setItem("wallet", address);
      } catch (err) {
        console.error("Connection Error:", err);
        alert("Wallet connection failed. Please try again.");
      }
    }
</script>

        <script>
          function openPopup(id) {
            const content = document.getElementById(id).innerHTML;
            document.getElementById('popupContent').innerHTML = content;
            document.getElementById('popupOverlay').style.display = 'flex';
          }
          function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
          }
        </script>
        
</body>
      </html>
